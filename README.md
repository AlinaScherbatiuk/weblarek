# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/main.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
# Интернет-магазин «Web-Larёk»
«Web-Larёk» — это интернет-магазин с товарами для веб-разработчиков, где пользователи могут просматривать товары, добавлять их в корзину и оформлять заказы. Сайт предоставляет удобный интерфейс с модальными окнами для просмотра деталей товаров, управления корзиной и выбора способа оплаты, обеспечивая полный цикл покупки с отправкой заказов на сервер.

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP (Model-View-Presenter), которая обеспечивает четкое разделение ответственности между классами слоев Model и View. Каждый слой несет свой смысл и ответственность:

Model - слой данных, отвечает за хранение и изменение данных.  
View - слой представления, отвечает за отображение данных на странице.  
Presenter - презентер содержит основную логику приложения и  отвечает за связь представления и данных.

Взаимодействие между классами обеспечивается использованием событийно-ориентированного подхода. Модели и Представления генерируют события при изменении данных или взаимодействии пользователя с приложением, а Презентер обрабатывает эти события используя методы как Моделей, так и Представлений.

### Базовый код

#### Класс Component
Является базовым классом для всех компонентов интерфейса.
Класс является дженериком и принимает в переменной `T` тип данных, которые могут быть переданы в метод `render` для отображения.

Конструктор:  
`constructor(container: HTMLElement)` - принимает ссылку на DOM элемент за отображение, которого он отвечает.

Поля класса:  
`container: HTMLElement` - поле для хранения корневого DOM элемента компонента.

Методы класса:  
`render(data?: Partial<T>): HTMLElement` - Главный метод класса. Он принимает данные, которые необходимо отобразить в интерфейсе, записывает эти данные в поля класса и возвращает ссылку на DOM-элемент. Предполагается, что в классах, которые будут наследоваться от `Component` будут реализованы сеттеры для полей с данными, которые будут вызываться в момент вызова `render` и записывать данные в необходимые DOM элементы.  
`setImage(element: HTMLImageElement, src: string, alt?: string): void` - утилитарный метод для модификации DOM-элементов `<img>`
 
#### Класс Api
Содержит в себе базовую логику отправки запросов.

Конструктор:  
`constructor(baseUrl: string, options: RequestInit = {})` - В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Поля класса:  
`baseUrl: string` - базовый адрес сервера  
`options: RequestInit` - объект с заголовками, которые будут использованы для запросов.

Методы:  
`get(uri: string): Promise<object>` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер  
`post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise<object>` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.  
`handleResponse(response: Response): Promise<object>` - защищенный метод проверяющий ответ сервера на корректность и возвращающий объект с данными полученный от сервера или отклоненный промис, в случае некорректных данных.

#### Класс EventEmitter
Брокер событий реализует паттерн "Наблюдатель", позволяющий отправлять события и подписываться на события, происходящие в системе. Класс используется для связи слоя данных и представления.

Конструктор класса не принимает параметров.

Поля класса:  
`_events: Map<string | RegExp, Set<Function>>)` -  хранит коллекцию подписок на события. Ключи коллекции - названия событий или регулярное выражение, значения - коллекция функций обработчиков, которые будут вызваны при срабатывании события.

Методы класса:  
`on<T extends object>(event: EventName, callback: (data: T) => void): void` - подписка на событие, принимает название события и функцию обработчик.  
`emit<T extends object>(event: string, data?: T): void` - инициализация события. При вызове события в метод передается название события и объект с данными, который будет использован как аргумент для вызова обработчика.  
`trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие с передачей в него данных из второго параметра.
 
## Архитектура

Проект использует архитектурный паттерн **MVP** (Model-View-Presenter).

### Модели данных

1. **ProductCatalog (Каталог товаров)**
2. **Cart (Корзина)**
3. **Buyer (Покупатель)**

### Описание классов

#### 1. **ProductCatalog (Каталог товаров)**

- **Описание**: Класс отвечает за хранение и работу с данными каталога товаров. Он управляет массивом товаров, предоставляет методы для получения всех товаров, получения товара по ID и установки нового списка товаров.

- **Конструктор**:
  ```ts
  constructor(initialProducts: IProduct[])
  ```
  Принимает массив товаров для инициализации.

- **Поля**:
  - `arrayProducts: IProduct[]`: Массив всех товаров в каталоге.
  - `cardProduct: IProduct`: Хранит информацию о товаре, выбранном для детального отображения.

- **Методы**:
  - `setArrayProducts(arrayProducts: IProduct[]): void` — Устанавливает новый массив товаров.
  - `getArrayProducts(): IProduct[]` — Возвращает копию массива товаров.
  - `getProduct(id: string): IProduct | undefined` — Возвращает товар по ID.

#### 2. **Cart (Корзина)**

- **Описание**: Класс отвечает за управление корзиной покупателя. Он хранит список товаров, выбранных для покупки, и предоставляет методы для добавления, удаления товаров, подсчета общей стоимости и проверки наличия товаров в корзине.

- **Конструктор**:
  ```ts
  constructor()
  ```
  Инициализирует корзину как пустую.

- **Поля**:
  - `cartItems: IProduct[]`: Массив товаров, добавленных в корзину.

- **Методы**:
  - `addItem(item: IProduct): void` — Добавляет товар в корзину.
  - `removeItem(id: string): void` — Удаляет товар из корзины по ID.
  - `getTotalPrice(): number` — Возвращает общую стоимость товаров в корзине.
  - `getCartItems(): IProduct[]` — Возвращает копию списка товаров в корзине.
  - `isItemInCart(id: string): boolean` — Проверяет, есть ли товар в корзине по ID.

#### 3. **Buyer (Покупатель)**

- **Описание**: Класс представляет покупателя, его данные и действия, связанные с оформлением заказа. Он отвечает за валидацию данных покупателя и получение информации о нем.

- **Конструктор**:
  ```ts
  constructor(payment: TPayment, email: string, phone: string, address: string)
  ```
  Принимает данные покупателя: тип оплаты, email, телефон и адрес.

- **Поля**:
  - `payment: 'card' | 'cash' | ''`: Тип оплаты покупателя.
  - `email: string`: Адрес электронной почты покупателя.
  - `phone: string`: Телефон покупателя.
  - `address: string`: Адрес доставки покупателя.

- **Методы**:
  - `getDetails(): IBuyer` — Возвращает все данные покупателя.
  - `clearBuyerData(): void` — Очищает все данные покупателя.
    - `validateField(field: keyof IBuyer)` — Проверяет, заполнены ли конкретное поле.
  - `validate(): boolean` — Проверяет, заполнены ли все обязательные поля (email, телефон, адрес).

#### 4. **ApiCommunication (АПИ комунникация)**

- **Описание**: Класс отвечает за взаимодействие с АПИ.

- **Конструктор**:
  ```ts
  constructor(private api: IApi)
  ```
  Принимает методы get и post.
 
- **Методы**:
  - `getProducts(): Promise<IProduct[]> ` — Возвращает список продуктов с сервера.
  - `createOrder(payload: IOrderRequest): Promise<IOrderResponse>` — Отправляет заказ на сервер.
  

### Типы данных

#### 1. **IProduct (Товар)**

- **Описание**: Описание товара, который может быть добавлен в каталог и в корзину.

```ts
interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: Price;
}
```

- **Поля**:
  - `id: string`: Уникальный идентификатор товара.
  - `description: string`: Описание товара.
  - `image: string`: Ссылка на изображение товара.
  - `title: string`: Название товара.
  - `category: string`: Категория товара.
  - `price: Price`: Цена товара (может быть `null`, если цена недоступна).

#### 2. **IBuyer (Покупатель)**

- **Описание**: Описание данных покупателя для оформления заказа.

```ts
interface IBuyer {
  payment: TPayment;
  email: string;
  phone: string;
  address: string;
}
```

- **Поля**:
  - `payment: TPayment`: Выбор способа оплаты покупателем.
  - `email: string`: Адрес электронной почты покупателя.
  - `phone: string`: Телефон покупателя.
  - `address: string`: Адрес доставки покупателя.

#### 3. **TPayment (Способ оплаты)**

```ts
type TPayment = "card" | "cash" | "";
```

- **Описание**: Тип, представляющий возможные способы оплаты.

#### 4. **Price (Стоимость)**

```ts
 type Price = number | null;
```

- **Описание**: Тип, представляющий стоимость продукта.

### Взаимодействие с сервером

Для работы с API используется предметный сервис ApiCommunication, который позволяет взаимодействовать с сервером для получения списка товаров и отправки данных о заказе.

- **Методы API**:
  - `getProducts(): Promise<IProduct[]>` — Получает список товаров с сервера.
  - `createOrder(payload: IOrderRequest): Promise<IOrderResponse>` — Отправляет данные о заказе на сервер.

---

## Слой Представления (View)

Каждый класс представления отвечает за свой блок разметки и работает с соответствующим `<template>` из вёрстки. В проекте выделены базовые абстракции и специализированные компоненты.

### Базовые абстракции

#### `BaseCardView<T>`
Базовый класс карточек. Инкапсулирует общий функционал:
- ссылки на элементы карточки (`titleEl`, `priceEl`, `categoryEl`, `imgEl`/`imgBoxEl`);
- единое форматирование цены (поддержка `null` как «Бесценно»);
- применение изображения (плейсхолдер при невалидном src);
- установка категории: русский текст + CSS‑модификатор по карте категорий.

Ключевые методы:
- `setTitle(text: string)` — установка заголовка;
- `setPrice(price)` — вывод стоимости/«Бесценно»;
- `setCategory(name?: string)` — подпись и модификатор класса категории;
- `applyImage(src?: string, alt?: string)` — установка изображения или плейсхолдера.

#### `BaseFormView<T>`
Базовый класс для форм. Содержит общий функционал:
- `formEl` — корневой элемент формы;
- `submitBtn`, `errorsEl` — стандартные элементы управления;
- `setSubmitDisabled(disabled: boolean)` — блокировка/разблокировка сабмита;
- `setError(message: string)` — вывод общего текста ошибки;
- дефолтный `render()` — возвращает `formEl`.

 ## View-компоненты

### `ProductGrid`

**Назначение.** Отрисовка сетки карточек товаров на странице каталога.

**Поля**
- `private root: HTMLElement` — корневой контейнер сетки.
- `private cards: Map<string, GridCard>` — кэш карточек по `id`.
- `private viewState: CatalogState` — текущее состояние.

**Методы**
- `setState(state: CatalogState): void` — применить состояние и обновить DOM.
- `getElement(): HTMLElement` — вернуть корневой контейнер.

**События**
- Не эмитит. Карточки внутри сетки эмитят `product/open`.

---

### `GridCard`

**Назначение.** Карточка товара в сетке каталога.

**Поля**
- `private root: HTMLElement` — корневой элемент карточки.
- `private id: ProductId` — идентификатор товара.

**Методы**
- `getElement(): HTMLElement` — вернуть DOM-элемент карточки.

**События**
- `product/open` — эмитится при клике по карточке.

---

### `CartPanel`

**Назначение.** Отображение корзины в модальном окне: список позиций, итоговая сумма, кнопка «Оформить».

**Поля**
- `private root: HTMLElement` — контейнер панели.
- `private listEl: HTMLElement` — контейнер списка.
- `private totalEl: HTMLElement` — элемент суммы.
- `private checkoutBtn: HTMLButtonElement` — кнопка оформления.

**Методы**
- `set items(items: HTMLElement[]): void` — заменить список готовыми узлами (`BasketLine`).
- `set total(value: number): void` — обновить сумму.
- `render(): HTMLElement` — вернуть контейнер.

**События**
- `basket/remove` — при удалении товара.
- `basket/checkout` — при клике «Оформить».

---

### `BasketLine`

**Назначение.** Строка товара в корзине.

**Поля**
- `private root: HTMLElement`
- `private id: ProductId`

**Методы**
- `getElement(): HTMLElement`

**События**
- `basket/remove` — при клике на кнопку удаления.

---

### `ProductQuicklook`

**Назначение.** Предпросмотр товара в модалке.

**Поля**
- `private root: HTMLElement`
- `private id: ProductId`
- `private price: Price`
- `private inBasket: boolean`

**Методы**
- `getElement(): HTMLElement`
- `setInBasket(value: boolean): void` — синхронизировать состояние кнопки.

**События**
- `product/add` — при клике «Купить».
- `basket/remove` — при клике «Удалить из корзины».

---

### `CheckoutDetailsStep`

**Назначение.** Форма выбора способа оплаты и адреса доставки.

**Поля**
- `private addressInput: HTMLInputElement`
- `private payCardBtn: HTMLButtonElement`
- `private payCashBtn: HTMLButtonElement`

**Методы**
- `render(): HTMLElement`
- `applyState(state: { payment?: string; address?: string }): void` — применить состояние модели.
- `showErrors(errors: { payment?: string; address?: string }): void` — отобразить ошибки.

**События**
- `order:change` — при изменении полей.
- `order/step1/next` — при сабмите.

---

### `CheckoutContactsStep`

**Назначение.** Форма ввода email и телефона.

**Поля**
- `private emailInput: HTMLInputElement`
- `private phoneInput: HTMLInputElement`

**Методы**
- `render(): HTMLElement`
- `showErrors(errors: { email?: string; phone?: string }): void`

**События**
- `order:change`
- `order/step2/pay`

---

### `CartToggleButton`

**Назначение.** Кнопка корзины в шапке.

**Поля**
- `private root: HTMLButtonElement`
- `private counterEl: HTMLElement`

**Методы**
- `setCount(n: number): void`

**События**
- `basket/open`

---

### `OverlayDialog`

**Назначение.** Модальное окно.

**Поля**
- `private overlay: HTMLElement`
- `private windowEl: HTMLElement`
- `private content: HTMLElement`
- `private lastActive: HTMLElement | null`

**Методы**
- `open(node: HTMLElement): void`
- `close(): void`
- `setContent(node: HTMLElement): void`

**События**
- `modal/close`

---
## Models

### `ProductCatalog`
Методы: `setArrayProducts(items)`, `getArrayProducts()`, `getProduct(id)`.

### `Cart`
Методы: `addItem(product)`, `removeItem(id)`, `isItemInCart(id)`, `getCartItems()`, `getTotalPrice()`.

### `Buyer`
Методы: `setBuyerData(partial)`, `changeData(key, value)`, `validate()` (эмитит `form:errors`).

---
## Презентер

Так как приложение одностраничное, используется один презентер (см. `src/main.ts`), который координирует работу страницы.

**Инициализация**
- создаёт модели каталога/корзины/покупателя;
- подготавливает представления: `ProductGrid`, `CartToggleButton`, `CartPanel`, `OverlayDialog`; формы `CheckoutDetailsStep` и `CheckoutContactsStep` создаются по сценарию;
- связывает компоненты через события/коллбеки.

**Загрузка и рендер**
- получает каталог через сервисный слой (`Api` + предметный сервис), преобразует данные и передаёт их в `ProductGrid`;
- синхронизирует счётчик корзины в `CartToggleButton` после любых изменений.

**Пользовательские сценарии**
- клик по карточке → открывает `ProductQuicklook` в `OverlayDialog`;
- «купить/удалить» → обновляет модель корзины и перерисовывает каталог/счётчик;
- клик по кнопке корзины → открывает `CartPanel`; удаление позиции в `BasketLine` — немедленно обновляет корзину;
- оформление: `CheckoutDetailsStep` → `CheckoutContactsStep` → POST‑заказ → попап успеха → очистка корзины.

**Ошибки и валидация**
- сетевые ошибки перехватываются и отображаются пользователю;
- формы блокируют сабмит до валидного состояния, сообщения выводятся средствами базового класса форм.
